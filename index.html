<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Truck Route Maps — MVP (Leaflet · No API keys)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

  <!-- Leaflet Routing Machine (uses OSRM by default) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <!-- Leaflet Control Geocoder (Nominatim/Photon) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    :root { --bg:#0b1020; --card:#121a2f; --text:#e8ecf8; --muted:#a9b3c9; --accent:#6aa6ff; --danger:#ff6a6a; --ok:#4cd964; }
    * { box-sizing: border-box }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { display:grid; grid-template-rows:auto 1fr; height:100% }
    header { display:flex; gap:1rem; align-items:center; padding:.75rem 1rem; background: linear-gradient(180deg, rgba(255,255,255,.05), transparent); border-bottom:1px solid rgba(255,255,255,.08) }
    header h1 { margin:0; font-size:1rem; letter-spacing:.02em; color:var(--muted); font-weight:600 }
    .pill { padding:.35rem .6rem; border:1px solid rgba(255,255,255,.12); border-radius:999px; font-size:.8rem; color:var(--muted) }
    #map { width:100%; height:100% }

    .panel { position:absolute; top:76px; left:12px; z-index:500; background:var(--card); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:.8rem; box-shadow:0 8px 30px rgba(0,0,0,.35); width:min(460px, calc(100% - 24px)) }
    .row { display:flex; gap:.5rem; align-items:center; margin:.5rem 0 }
    .row > label { font-size:.85rem; color: var(--muted); min-width:106px }
    input[type="text"], input[type="number"], select {
      flex:1; padding:.6rem .65rem; border-radius:10px; border:1px solid rgba(255,255,255,.14);
      background:#0e1530; color:var(--text); outline:none;
    }
    button { padding:.7rem 1rem; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:#0f1a39; color:var(--text); cursor:pointer }
    button.primary { background: linear-gradient(180deg, #1a4fff, #0a3fff); border-color:#0a39d4 }
    button.ghost { background:transparent }
    .mini { font-size:.85rem; color:var(--muted) }
    .chip { border:1px solid rgba(255,255,255,.2); border-radius:999px; padding:.35rem .6rem; cursor:pointer; display:inline-block; margin-right:.35rem }
    .chip.active { background:#14306e; border-color:#2a58d6 }
    .legend { position:absolute; right:12px; top:76px; z-index:500; background:var(--card); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:.6rem .8rem; font-size:.85rem }
    .legend .k { display:flex; align-items:center; gap:.5rem; margin:.25rem 0; color:var(--muted) }
    .dot { width:12px; height:12px; border-radius:3px; display:inline-block }
    .dot.bridge { background:#ff9f43 }
    .dot.osr { background:#4cd964 }
    .dot.low { background:#ff6a6a }
    .notice { position:absolute; left:50%; transform:translateX(-50%); top:76px; z-index:500; background:#1b2d5e; border:1px solid #2e5fff55; color:#cfe0ff; border-radius:12px; padding:.5rem .8rem; display:none }

    /* LRM panel trim for dark mode */
    .leaflet-routing-container { background: #0d1530cc; color:#dbe6ff; border:1px solid rgba(255,255,255,.12); border-radius:12px }
    .leaflet-bar a { background:#0e1530; border-color: rgba(255,255,255,.2); color:#fff }
    .leaflet-control-geocoder-form input { background:#0e1530; color:#fff; border:1px solid rgba(255,255,255,.2) }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Truck Route Maps</h1>
      <span class="pill">Leaflet · OSM · OSRM · No keys</span>
      <div class="mini">Basic: type+weight (24h). Premium: unit until changed.</div>
    </header>

    <div id="map"></div>

    <div class="panel" id="ui">
      <div class="row">
        <label>Mode</label>
        <div id="modeChips">
          <span class="chip active" data-mode="basic">Basic</span>
          <span class="chip" data-mode="premium">Premium</span>
        </div>
      </div>

      <div id="basicFields">
        <div class="row">
          <label>Truck type</label>
          <select id="truckType" autocomplete="off">
            <option value="">Select type…</option>
            <option value="9-axle">9-axle (2×2 + 2×3)</option>
            <option value="articulated-2">Artic (tractor + 2-axle)</option>
            <option value="articulated-3">Artic (tractor + 3-axle)</option>
            <option value="rigid">Rigid</option>
          </select>
        </div>
        <div class="row">
          <label>Total weight</label>
          <input id="grossWeight" type="number" min="0" step="0.1" placeholder="t — permitted or actual" />
        </div>
        <div class="mini">Selection persists for 24 h unless changed.</div>
      </div>

      <div id="premiumFields" style="display:none">
        <div class="row">
          <label>Truck unit</label>
          <select id="truckUnit"></select>
        </div>
        <div class="mini">Selection persists until you change it (per user).</div>
      </div>

      <hr style="border-color: rgba(255,255,255,.08); border-style: solid; border-width: 1px 0 0; margin:.5rem 0 .75rem" />

      <div class="row"><label>Origin</label><input id="origin" type="text" placeholder="Address, suburb, place…"/></div>
      <div class="row"><label>Destination</label><input id="destination" type="text" placeholder="Address, suburb, place…"/></div>
      <div class="row">
        <label></label>
        <button class="primary" id="routeBtn">Plot route</button>
        <button class="ghost" id="resetBtn">Reset</button>
      </div>

      <div id="routeStatus" class="mini"></div>
      <div id="warnings" class="mini"></div>
    </div>

    <div class="legend">
      <div class="k"><span class="dot bridge"></span> Bridges (max weight)</div>
      <div class="k"><span class="dot low"></span> Low overbridges (height)</div>
      <div class="k"><span class="dot osr"></span> Oversize corridors</div>
    </div>

    <div id="selectionNotice" class="notice">Please choose your truck to continue.</div>
  </div>

  <script>
    /* -------------------- Demo domain data (swap later) -------------------- */
    const DEMO_TRUCKS = [
      { id:'NJW08', label:'NJW08 (Artic 3-axle, 44t, 4.30m)', type:'articulated-3', gross_t:44, height_m:4.30 },
      { id:'KZX12', label:'KZX12 (9-axle, 53t, 4.25m)',       type:'9-axle',        gross_t:53, height_m:4.25 },
      { id:'TRG21', label:'TRG21 (Rigid, 25t, 4.10m)',        type:'rigid',         gross_t:25, height_m:4.10 },
    ];
    const DEMO_BRIDGES = [
      { name:'Bridge A', lat:-36.8485, lng:174.7633, max_t:44,  max_h:null },
      { name:'Bridge B', lat:-36.9200, lng:174.7750, max_t:30,  max_h:null },
      { name:'Low Overbridge C', lat:-36.8800, lng:174.7450, max_t:null, max_h:4.20 },
    ];
    const DEMO_OVERSIZE_CORRIDORS = [
      [ {lat:-36.85, lng:174.70}, {lat:-36.85, lng:174.90} ],
      [ {lat:-36.92, lng:174.70}, {lat:-36.80, lng:174.78} ],
    ];

    /* -------------------- Persistence (localStorage) -------------------- */
    const STORAGE_KEYS = {
      mode: 'trm_mode',               // 'basic' | 'premium'
      basic: 'trm_basic_sel',         // { truckType, gross_t, ts }
      premium: 'trm_premium_sel',     // { unitId }
    };
    const saveBasicSelection = ({truckType, gross_t}) =>
      localStorage.setItem(STORAGE_KEYS.basic, JSON.stringify({truckType, gross_t, ts: Date.now()}));
    const readBasicSelection = () => {
      const raw = localStorage.getItem(STORAGE_KEYS.basic);
      if(!raw) return null;
      try {
        const o = JSON.parse(raw);
        if (Date.now() - (o.ts||0) > 86400000) { localStorage.removeItem(STORAGE_KEYS.basic); return null; } // 24h
        return o;
      } catch { return null; }
    };
    const savePremiumSelection = (unitId) =>
      localStorage.setItem(STORAGE_KEYS.premium, JSON.stringify({ unitId }));
    const readPremiumSelection = () => {
      const raw = localStorage.getItem(STORAGE_KEYS.premium);
      if(!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    };
    const saveMode = (m)=> localStorage.setItem(STORAGE_KEYS.mode, m);
    const readMode = ()=> localStorage.getItem(STORAGE_KEYS.mode) || 'basic';

    /* -------------------- App state -------------------- */
    let map, routingControl;
    let currentTruck = null; // { type, gross_t, height_m?, unitId? }
    let mode = 'basic';
    let bridgeLayer, lowLayer, osrLayer;
    let lastRouteCoords = [];
    let clickedPoints = [];

    /* -------------------- Helpers -------------------- */
    const qs = (s, el=document)=>el.querySelector(s);
    const qsa = (s, el=document)=>[...el.querySelectorAll(s)];
    const setChipsActive = (container, v) =>
      qsa('.chip', container).forEach(ch=>ch.c
